#!/bin/bash

# args: source

set -e

IFS=':' read SCS_REQUIRES_MASTER_HOST SCS_REQUIRES_MASTER_PORT SCS_REQUIRES_MASTER_EXTRA <<< "$SCS_REQUIRES_MASTER"

if ( `mysql -e 'SHOW SLAVE STATUS' | grep Master_Host` 2>&1 >/dev/null ) ; then
    mysql -e 'STOP SLAVE'
fi

cat | mysql <<EOF
UPDATE CHANGE MASTER TO MASTER_HOST="$SCS_REQUIRES_MASTER_HOST", MASTER_PORT="$SCS_REQUIRES_MASTER_PORT", MASTER_USER="<%= scope['master_username'] %>", MASTER_PASSWORD="<%= scope['master_password'] %>"
EOF

mysql -e 'START SLAVE'
